name: Publish netrun-config to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish_to:
        description: 'Publish to (test/prod)'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - prod

defaults:
  run:
    working-directory: Service_63_Unified_Configuration

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Get version from pyproject.toml
      id: get-version
      run: |
        VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"

    - name: Validate version format
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Error: Version '$VERSION' does not match semantic versioning (X.Y.Z)"
          exit 1
        fi

    - name: Check version against tag (if release)
      if: github.event_name == 'release'
      run: |
        TAG_VERSION="${{ github.event.release.tag_name }}"
        PACKAGE_VERSION="v${{ steps.get-version.outputs.version }}"
        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "Error: Release tag ($TAG_VERSION) does not match package version ($PACKAGE_VERSION)"
          exit 1
        fi

  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: validate-version

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel setuptools

    - name: Build source distribution
      run: |
        python -m build --sdist

    - name: Build wheel distribution
      run: |
        python -m build --wheel

    - name: Verify distributions
      run: |
        twine check dist/*
        ls -lh dist/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: netrun-config-dist-${{ needs.validate-version.outputs.version }}
        path: Service_63_Unified_Configuration/dist/
        retention-days: 30

  test-install:
    name: Test Installation from Build
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: netrun-config-dist-${{ needs.validate-version.outputs.version }}
        path: dist/

    - name: Install from wheel
      run: |
        pip install dist/*.whl

    - name: Validate core imports
      run: |
        python -c "from netrun_config import BaseConfig, get_settings, reload_settings"
        python -c "from netrun_config import Field"
        python -c "from netrun_config import ConfigError, ValidationError, KeyVaultError"

    - name: Validate Azure extras
      run: |
        pip install dist/*.whl[azure]
        python -c "from netrun_config import KeyVaultMixin"

    - name: Test functionality
      run: |
        python -c "
        from netrun_config import BaseConfig, Field, get_settings
        import os

        # Test basic configuration
        class AppConfig(BaseConfig):
            app_name: str = Field(default='test-app')
            debug: bool = Field(default=False)

        config = get_settings(AppConfig)
        assert config.app_name == 'test-app'
        assert config.debug is False
        assert config.environment in ['development', 'staging', 'production']

        print('âœ“ All validation tests passed')
        "

  publish-test-pypi:
    name: Publish to Test PyPI
    runs-on: ubuntu-latest
    needs: [validate-version, build, test-install]
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.publish_to == 'test'
    environment:
      name: test-pypi
      url: https://test.pypi.org/p/netrun-config

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: netrun-config-dist-${{ needs.validate-version.outputs.version }}
        path: dist/

    - name: Publish to Test PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository-url: https://test.pypi.org/legacy/
        packages-dir: dist/
        skip-existing: true

    - name: Verify Test PyPI publication
      run: |
        sleep 30  # Wait for Test PyPI to index
        pip index versions netrun-config --index-url https://test.pypi.org/simple/

  publish-pypi:
    name: Publish to Production PyPI
    runs-on: ubuntu-latest
    needs: [validate-version, build, test-install]
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to == 'prod')
    environment:
      name: pypi
      url: https://pypi.org/p/netrun-config
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: netrun-config-dist-${{ needs.validate-version.outputs.version }}
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages-dir: dist/

    - name: Create GitHub release artifacts
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        fail_on_unmatched_files: true

  verify-publication:
    name: Verify PyPI Publication
    runs-on: ubuntu-latest
    needs: publish-pypi

    steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Wait for PyPI indexing
      run: sleep 60

    - name: Install from PyPI
      run: |
        pip install netrun-config==${{ needs.validate-version.outputs.version }}

    - name: Verify installation
      run: |
        python -c "import netrun_config; print(f'âœ“ Successfully installed netrun-config v{netrun_config.__version__} from PyPI')"

    - name: Test imports
      run: |
        python -c "from netrun_config import BaseConfig, get_settings, Field, ConfigError"
        echo "âœ“ All imports successful"

  notify-success:
    name: Notify Publication Success
    runs-on: ubuntu-latest
    needs: [validate-version, verify-publication]
    if: success()

    steps:
    - name: Create success summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY <<EOF
        ## ðŸŽ‰ netrun-config v${{ needs.validate-version.outputs.version }} Published Successfully

        **Package:** netrun-config
        **Version:** ${{ needs.validate-version.outputs.version }}
        **PyPI URL:** https://pypi.org/project/netrun-config/${{ needs.validate-version.outputs.version }}/

        ### Installation
        \`\`\`bash
        pip install netrun-config==${{ needs.validate-version.outputs.version }}
        \`\`\`

        ### With Azure support
        \`\`\`bash
        pip install netrun-config[azure]==${{ needs.validate-version.outputs.version }}
        \`\`\`
        EOF
