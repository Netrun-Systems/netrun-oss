name: Test netrun-config (Service 63)

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - 'Service_63_Unified_Configuration/**'
      - '.github/workflows/test-service63.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Service_63_Unified_Configuration/**'
      - '.github/workflows/test-service63.yml'
  workflow_dispatch:

defaults:
  run:
    working-directory: Service_63_Unified_Configuration

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev,azure]"

    - name: Lint with ruff
      run: |
        ruff check netrun_config/ tests/
      continue-on-error: true

    - name: Format check with black
      run: |
        black --check netrun_config/ tests/
      continue-on-error: true

    - name: Type check with mypy
      run: |
        mypy netrun_config/
      continue-on-error: true

    - name: Run tests with pytest
      run: |
        pytest --cov=netrun_config --cov-report=xml --cov-report=term-missing

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./Service_63_Unified_Configuration/coverage.xml
        flags: service63
        name: netrun-config
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: Run Bandit security scan
      run: |
        bandit -r netrun_config/ -f json -o bandit-report.json
      continue-on-error: true

    - name: Run Safety check
      run: |
        safety check --json
      continue-on-error: true

  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: [test, security]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package with twine
      run: |
        twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ github.sha }}
        path: Service_63_Unified_Configuration/dist/
        retention-days: 7

  validate-install:
    name: Validate Installation
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-${{ github.sha }}
        path: dist/

    - name: Install from wheel
      run: |
        pip install dist/*.whl

    - name: Validate imports
      run: |
        python -c "from netrun_config import BaseConfig, get_settings, Field"
        python -c "from netrun_config import ConfigError, ValidationError, KeyVaultError"
        python -c "from netrun_config import KeyVaultMixin"
        python -c "import netrun_config; print(f'netrun-config v{netrun_config.__version__} installed successfully')"

    - name: Test basic functionality
      run: |
        python -c "
        from netrun_config import BaseConfig, Field, get_settings

        class TestConfig(BaseConfig):
            app_name: str = Field(default='test-app')

        config = get_settings(TestConfig)
        assert config.app_name == 'test-app'
        assert config.environment in ['development', 'staging', 'production']
        print('âœ“ Basic functionality validated')
        "
